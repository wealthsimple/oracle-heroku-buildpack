#!/usr/bin/env ruby

require 'tempfile'
require 'fileutils'

$stdout.sync = true

def indent msg
  puts "       #{msg}"
end

BUILD_DIR=ARGV[0]
CACHE_DIR=ARGV[1]
ENV_DIR=ARGV[2]

indent "BUILD_DIR=#{BUILD_DIR}"
indent "CACHE_DIR=#{CACHE_DIR}"
indent "ENV_DIR=#{ENV_DIR.inspect}"

Dir.foreach(ENV_DIR) { |x| indent x }

puts "-----> Found a .oracle.ini"

ORACLE_INSTANT_CLIENT_DIR="#{ARGV[0]}/vendor/oracle_instantclient"

ORACLE_INSTANT_CLIENT_URL="https://www.dropbox.com/s/eadlfff7w9bjo44/instantclient-full-linux.x64-12.1.0.tar.gz"
ORACLE_INSTANT_CLIENT_FILENAME=ORACLE_INSTANT_CLIENT_URL.split(/\//).last

indent "Making directory #{ORACLE_INSTANT_CLIENT_DIR}"
`mkdir -p #{ORACLE_INSTANT_CLIENT_DIR}`

indent "Downloading and extracting #{ORACLE_INSTANT_CLIENT_FILENAME}"
result = `curl #{ORACLE_INSTANT_CLIENT_URL} -L -s -o - | tar -xvz -C #{ORACLE_INSTANT_CLIENT_DIR} -f - `

unless $?.success?
  indent "Failure while downloading Oracle instant client archive: #{$?}"
  exit 1
end

result = `ls -l #{ORACLE_INSTANT_CLIENT_DIR}`
indent result

indent "Successfully extracted #{ORACLE_INSTANT_CLIENT_FILENAME}"

indent "Create profile.d script"
`mkdir -p #{BUILD_DIR}/.profile.d`

# open("#{BUILD_DIR}/.profile.d/oracle.sh", "w") do |f|
#   f.puts "export LD_LIBRARY_PATH=#{ORACLE_INSTANT_CLIENT_DIR}:LD_LIBRARY_PATH"
# end
puts "export LD_LIBRARY_PATH=#{ORACLE_INSTANT_CLIENT_DIR}:LD_LIBRARY_PATH"
`export LD_LIBRARY_PATH=#{ORACLE_INSTANT_CLIENT_DIR}:LD_LIBRARY_PATH`

indent "Done!"
